<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מילון צ'כית בענן</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #002b5b;
            --secondary: #ed1c24;
            --success: #28a745;
            --danger: #dc3545;
            --light: #f8f9fa;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        header {
            text-align: center;
            border-bottom: 2px solid var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
        }

        .score-board {
            display: flex;
            justify-content: center;
            gap: 20px;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .correct { color: var(--success); }
        .wrong { color: var(--danger); }

        .tabs {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: #e9ecef;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        section { display: none; }
        section.active { display: block; }

        input, button {
            padding: 12px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .btn-main {
            background-color: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-main:disabled { opacity: 0.5; cursor: not-allowed; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            text-align: right;
        }

        .delete-btn { color: var(--danger); cursor: pointer; background: none; border: none; }

        /* Game Styles */
        .game-container { text-align: center; padding: 20px; }
        .card {
            font-size: 2.5rem;
            padding: 50px;
            background: var(--light);
            border: 3px solid var(--primary);
            border-radius: 15px;
            margin-bottom: 30px;
            font-weight: bold;
        }
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .option-btn {
            padding: 20px;
            font-size: 1.2rem;
            background: white;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 10px;
        }
        .option-btn:hover { border-color: var(--primary); }
        .correct-choice { background-color: var(--success) !important; color: white; border-color: var(--success); }
        .wrong-choice { background-color: var(--danger) !important; color: white; border-color: var(--danger); }
        
        #next-btn { margin-top: 30px; display: none; width: 200px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>🇨🇿 מילון צ'כית חכם 🇮🇱</h1>
        <div class="score-board">
            <span>נכונות: <span id="correct-score" class="correct">0</span></span>
            <span> | </span>
            <span>שגויות: <span id="wrong-score" class="wrong">0</span></span>
        </div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('dictionary')">ניהול מילים</button>
        <button class="tab-btn" onclick="showTab('game')">משחק זיכרון</button>
    </div>

    <section id="dictionary" class="active">
        <input type="text" id="search-input" style="width:100%; box-sizing:border-box;" placeholder="חפש מילה בעברית או בצ'כית..." oninput="searchWord()">
        <div id="search-result-msg" style="margin: 10px 0;"></div>

        <div class="form-group">
            <h3>הוספת מילה חדשה</h3>
            <input type="text" id="new-cs" placeholder="צ'כית (למשל: Dobrý den)">
            <input type="text" id="new-he" placeholder="עברית (למשל: יום טוב)">
            <button class="btn-main" id="add-btn" onclick="addWord()">שמור לענן ☁️</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th>צ'כית</th>
                    <th>עברית</th>
                    <th>מחיקה</th>
                </tr>
            </thead>
            <tbody id="words-table-body"></tbody>
        </table>
    </section>

    <section id="game">
        <div id="game-ui" class="game-container">
            <div class="card" id="question-card">טוען...</div>
            <div class="options-grid" id="options-grid"></div>
            <button id="next-btn" class="btn-main" onclick="startNewRound()">למילה הבאה</button>
        </div>
        <div id="game-error" style="display:none; text-align:center; padding: 40px;">
            צריך לפחות 4 מילים במילון כדי לשחק.
        </div>
    </section>
</div>

<script>
    // --- הגדרות חיבור ל-SUPABASE ---
    const SUPABASE_URL = 'https://gjygcfgbgfiaaidzyzji.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdqeWdjZmdiZ2ZpYWFpZHp5emppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3MDgwMjYsImV4cCI6MjA4NTI4NDAyNn0.nV8ocbbXxnj0kqapUHLxE1rN5qfEi9bgoUfWclp80KI';
    
	const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
	
    let words = [];
    let gameStack = []; // רשימת המילים למשחק הנוכחי
    let currentWordIndex = 0;
    let score = { correct: 0, wrong: 0 };
    let autoNextTimer = null;

    // טעינה ראשונית
    async function fetchWords() {
        const { data, error } = await _supabase.from('vocabulary').select('*').order('created_at', { ascending: false });
        if (error) console.error(error);
        else words = data;
        renderTable();
    }

    // הוספת מילה לענן
    async function addWord() {
        const cs = document.getElementById('new-cs').value.trim();
        const he = document.getElementById('new-he').value.trim();
        if (!cs || !he) return alert("מלא את כל השדות");

        const btn = document.getElementById('add-btn');
        btn.disabled = true;
        const { error } = await _supabase.from('vocabulary').insert([{ czech: cs, hebrew: he }]);
        
        if (error) alert("שגיאה: " + error.message);
        else {
            document.getElementById('new-cs').value = '';
            document.getElementById('new-he').value = '';
            await fetchWords();
        }
        btn.disabled = false;
    }

    async function deleteWord(id) {
        if (!confirm("למחוק?")) return;
        await _supabase.from('vocabulary').delete().eq('id', id);
        fetchWords();
    }

    function renderTable(filterWords = null) {
        const list = filterWords || words;
        document.getElementById('words-table-body').innerHTML = list.map(w => `
            <tr><td>${w.czech}</td><td>${w.hebrew}</td>
            <td><button class="delete-btn" onclick="deleteWord(${w.id})">🗑️</button></td></tr>
        `).join('');
    }

    function showTab(tabId) {
        document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.currentTarget.classList.add('active');
        if(tabId === 'game') initGame();
    }

    // --- לוגיקת המשחק החדשה ---

    function initGame() {
        if (words.length < 4) {
            document.getElementById('game-ui').style.display = 'none';
            document.getElementById('game-error').style.display = 'block';
            return;
        }
        
        document.getElementById('game-ui').style.display = 'block';
        document.getElementById('game-error').style.display = 'none';
        
        // איפוס נתונים למשחק חדש
        score = { correct: 0, wrong: 0 };
        document.getElementById('correct-score').innerText = "0";
        document.getElementById('wrong-score').innerText = "0";
        
        // ערבוב המילים ויצירת תור למשחק
        gameStack = [...words].sort(() => 0.5 - Math.random());
        currentWordIndex = 0;
        
        startNewRound();
    }

    function startNewRound() {
        if (autoNextTimer) clearTimeout(autoNextTimer); // ביטול טיימר קודם אם היה
        
        if (currentWordIndex >= gameStack.length) {
            showSummary();
            return;
        }

        document.getElementById('next-btn').style.display = 'none';
        const grid = document.getElementById('options-grid');
        grid.innerHTML = '';

        const correctWord = gameStack[currentWordIndex];
        document.getElementById('question-card').innerText = correctWord.czech;

        // יצירת מסיחים ייחודיים (לא כולל המילה הנכונה)
        let distractors = words
            .filter(w => w.id !== correctWord.id)
            .sort(() => 0.5 - Math.random())
            .slice(0, 3);

        let options = [correctWord, ...distractors].sort(() => 0.5 - Math.random());

        options.forEach(opt => {
            const b = document.createElement('button');
            b.className = 'option-btn';
            b.innerText = opt.hebrew;
            b.onclick = () => handleAnswer(b, opt.id === correctWord.id);
            grid.appendChild(b);
        });
    }

    function handleAnswer(selectedBtn, isCorrect) {
        // מניעת לחיצות כפולות
        document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);

        if (isCorrect) {
            selectedBtn.classList.add('correct-choice');
            score.correct++;
        } else {
            selectedBtn.classList.add('wrong-choice');
            score.wrong++;
        }

        document.getElementById('correct-score').innerText = score.correct;
        document.getElementById('wrong-score').innerText = score.wrong;
        document.getElementById('next-btn').style.display = 'inline-block';

        currentWordIndex++;
        
        // מעבר אוטומטי אחרי 3 שניות
        autoNextTimer = setTimeout(startNewRound, 3000);
    }

    function showSummary() {
        const total = gameStack.length;
        const percent = Math.round((score.correct / total) * 100);
        let color = "";

        if (percent < 50) color = "#dc3545"; // אדום
        else if (percent < 70) color = "#fd7e14"; // כתום
        else if (percent < 80) color = "#a3cfbb"; // ירוק בהיר
        else color = "#198754"; // ירוק כהה

        document.getElementById('game-ui').innerHTML = `
            <div style="padding: 40px; border: 2px solid #ddd; border-radius: 15px;">
                <h2>סיימת את כל המילים! 🏁</h2>
                <p>תשובות נכונות: ${score.correct}</p>
                <p>טעויות: ${score.wrong}</p>
                <h1 style="color: ${color}; font-size: 4rem;">${percent}%</h1>
                <button class="btn-main" onclick="location.reload()">משחק חדש</button>
            </div>
        `;
    }

    // חיפוש
    function searchWord() {
        const q = document.getElementById('search-input').value.toLowerCase();
        const msg = document.getElementById('search-result-msg');
        if (!q) { msg.innerHTML = ''; renderTable(); return; }

        const found = words.find(w => w.czech.toLowerCase() === q || w.hebrew === q);
        if (found) msg.innerHTML = `<b style="color:green">נמצא: ${found.czech} = ${found.hebrew}</b>`;
        else msg.innerHTML = `<span style="color:red">לא נמצא.</span>`;
        
        renderTable(words.filter(w => w.czech.toLowerCase().includes(q) || w.hebrew.includes(q)));
    }

    fetchWords();
</script>

</body>
</html>